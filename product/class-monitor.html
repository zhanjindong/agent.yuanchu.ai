<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘æ˜¯ç­é•¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #classroom {
            position: relative;
            width: 95vw;
            height: 90vh;
            background: linear-gradient(180deg, #f5f5f5 0%, #e8e8e8 100%);
            border-radius: 20px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        /* é»‘æ¿ */
        #blackboard {
            position: absolute;
            top: 3%;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            height: 18%;
            background: linear-gradient(180deg, #2d5a27 0%, #1e3d1a 100%);
            border-radius: 8px;
            border: 8px solid #8b4513;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.3);
        }

        .blackboard-text {
            color: rgba(255,255,255,0.9);
            font-size: clamp(14px, 2.5vw, 24px);
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            text-align: center;
            line-height: 1.6;
        }

        /* è¯¾æ¡ŒåŒºåŸŸ */
        #desks {
            position: absolute;
            top: 25%;
            left: 3%;
            width: 94%;
            height: 70%;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 6px;
        }

        .desk {
            background: linear-gradient(180deg, #d4a574 0%, #c4956a 100%);
            border-radius: 6px;
            border: 2px solid #8b6914;
            box-shadow: 2px 2px 6px rgba(0,0,0,0.15);
        }

        /* å­¦ç”Ÿç½‘æ ¼ */
        #students {
            position: absolute;
            top: 25%;
            left: 3%;
            width: 94%;
            height: 70%;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 6px;
            z-index: 10;
        }

        .student {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            cursor: default;
            padding-bottom: 4px;
        }

        .student-body {
            width: clamp(24px, 4.5vw, 40px);
            height: clamp(28px, 5vw, 48px);
            border-radius: 50% 50% 45% 45%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: clamp(10px, 1.8vw, 14px);
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            flex-shrink: 0;
        }

        /* æ³¡æ³¡ */
        .bubble {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: clamp(16px, 3.2vw, 28px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            border: 2px solid #ddd;
            width: clamp(30px, 5vw, 44px);
            height: clamp(30px, 5vw, 44px);
            cursor: pointer;
            z-index: 20;
            animation: bubbleAppear 0.4s ease-out, bubbleFloat 2s ease-in-out 0.4s infinite;
        }

        .bubble:hover {
            transform: translateX(-50%) scale(1.15);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        /* æ³¡æ³¡å€’è®¡æ—¶ç¯ */
        .bubble-timer {
            position: absolute;
            top: -3px;
            left: -3px;
            width: calc(100% + 6px);
            height: calc(100% + 6px);
            border-radius: 50%;
            pointer-events: none;
        }

        .bubble-timer circle {
            fill: none;
            stroke: #e74c3c;
            stroke-width: 3;
            stroke-dasharray: 126;
            stroke-dashoffset: 0;
            transform: rotate(-90deg);
            transform-origin: center;
            transition: stroke-dashoffset 0.5s linear;
        }

        @keyframes bubbleAppear {
            0% { transform: translateX(-50%) scale(0); opacity: 0; }
            60% { transform: translateX(-50%) scale(1.2); opacity: 1; }
            100% { transform: translateX(-50%) scale(1); opacity: 1; }
        }

        @keyframes bubbleFloat {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-4px); }
        }

        @keyframes bubbleExpire {
            0% { transform: translateX(-50%) scale(1); opacity: 1; }
            100% { transform: translateX(-50%) scale(0); opacity: 0; }
        }

        .bubble.expiring {
            animation: bubbleExpire 0.4s ease-in forwards;
        }

        /* å›åº”æ°”æ³¡ */
        .response-bubble {
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            background: #fffde7;
            border: 2px solid #ffd54f;
            border-radius: 12px;
            padding: 4px 8px;
            font-size: clamp(10px, 1.8vw, 13px);
            white-space: nowrap;
            z-index: 30;
            pointer-events: none;
            animation: responseShow 1.5s ease forwards;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .response-bubble::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 6px solid #ffd54f;
        }

        @keyframes responseShow {
            0% { opacity: 0; transform: translateX(-50%) translateY(5px); }
            15% { opacity: 1; transform: translateX(-50%) translateY(0); }
            75% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
        }

        /* çŠ¶æ€é¢œè‰² */
        .status-gaming { border-color: #9b59b6 !important; box-shadow: 0 3px 10px rgba(155,89,182,0.3) !important; }
        .status-toilet { border-color: #3498db !important; box-shadow: 0 3px 10px rgba(52,152,219,0.3) !important; }
        .status-fighting { border-color: #e74c3c !important; box-shadow: 0 3px 10px rgba(231,76,60,0.3) !important; }
        .status-talking { border-color: #1abc9c !important; box-shadow: 0 3px 10px rgba(26,188,156,0.3) !important; }
        .status-snack { border-color: #f39c12 !important; box-shadow: 0 3px 10px rgba(243,156,18,0.3) !important; }

        /* UIé¢æ¿ */
        #ui {
            position: absolute;
            top: 8px;
            left: 8px;
            right: 8px;
            display: flex;
            justify-content: space-between;
            z-index: 100;
        }

        .ui-box {
            background: rgba(255,255,255,0.95);
            padding: 8px 14px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-size: clamp(12px, 2.2vw, 18px);
            font-weight: bold;
        }

        #timer { color: #e74c3c; }
        #score { color: #27ae60; }
        #target { color: #9b59b6; }

        /* é€‰æ‹©å¼¹çª— */
        #choiceModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #choiceModal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            max-width: 90%;
            min-width: 280px;
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-title {
            font-size: clamp(18px, 4vw, 24px);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .modal-subtitle {
            font-size: clamp(12px, 2.5vw, 15px);
            color: #888;
            margin-bottom: 10px;
        }

        .choice-btn {
            display: block;
            width: 100%;
            padding: 14px 18px;
            margin: 8px 0;
            font-size: clamp(13px, 2.8vw, 17px);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
        }

        .choice-btn:hover {
            transform: scale(1.02);
        }

        .choice-btn:active {
            transform: scale(0.98);
        }

        .choice-positive {
            background: linear-gradient(180deg, #27ae60 0%, #1e8449 100%);
            color: white;
        }

        .choice-negative {
            background: linear-gradient(180deg, #e67e22 0%, #d35400 100%);
            color: white;
        }

        .choice-neutral {
            background: linear-gradient(180deg, #95a5a6 0%, #7f8c8d 100%);
            color: white;
        }

        .points-tag {
            font-size: 0.75em;
            opacity: 0.9;
            margin-left: 6px;
        }

        /* å¼€å§‹/ç»“æŸç•Œé¢ */
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            color: white;
        }

        #overlay.hidden {
            display: none;
        }

        #overlay h1 {
            font-size: clamp(32px, 8vw, 60px);
            margin-bottom: 20px;
            text-shadow: 0 0 30px rgba(255,215,0,0.5);
        }

        #overlay .subtitle {
            font-size: clamp(16px, 4vw, 24px);
            margin-bottom: 30px;
            color: #ccc;
        }

        #overlay .info {
            font-size: clamp(13px, 2.8vw, 17px);
            margin-bottom: 25px;
            max-width: 85%;
            line-height: 2;
            text-align: center;
            color: #bbb;
        }

        .start-btn {
            padding: 18px 60px;
            font-size: clamp(18px, 4vw, 24px);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            background: linear-gradient(180deg, #ffd700 0%, #ff8c00 100%);
            color: #333;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(255,215,0,0.4);
        }

        .start-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 30px rgba(255,215,0,0.6);
        }

        .start-btn:active {
            transform: scale(0.95);
        }

        .result-icon {
            font-size: clamp(60px, 15vw, 100px);
            margin-bottom: 20px;
        }

        .result-title {
            font-size: clamp(20px, 5vw, 36px);
            margin-bottom: 15px;
            line-height: 1.5;
            max-width: 85%;
            text-align: center;
        }

        .result-score {
            font-size: clamp(18px, 4vw, 28px);
            margin-bottom: 30px;
        }

        .win { color: #2ecc71; }
        .lose { color: #e74c3c; }

        /* çŠ¶æ€å›¾ä¾‹ */
        #legend {
            position: absolute;
            bottom: 6px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            z-index: 50;
        }

        .legend-item {
            background: rgba(255,255,255,0.9);
            padding: 3px 8px;
            border-radius: 20px;
            font-size: clamp(9px, 1.8vw, 13px);
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .legend-icon {
            font-size: clamp(12px, 2.2vw, 16px);
        }

        /* é£˜åˆ†æ•ˆæœ */
        .float-score {
            position: absolute;
            font-size: clamp(16px, 3vw, 24px);
            font-weight: bold;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
            z-index: 500;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }

        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-40px); }
        }

        /* åˆ†æ•°åŠ¨ç”» */
        @keyframes scoreAdd {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        .score-animate {
            animation: scoreAdd 0.4s ease;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="classroom">
            <!-- é»‘æ¿ -->
            <div id="blackboard">
                <div class="blackboard-text">ğŸ–ï¸ è€å¸ˆä¸åœ¨ï¼Œç­é•¿è´Ÿè´£ï¼</div>
            </div>

            <!-- è¯¾æ¡Œ -->
            <div id="desks"></div>

            <!-- å­¦ç”Ÿå®¹å™¨ -->
            <div id="students"></div>

            <!-- UI -->
            <div id="ui">
                <div class="ui-box" id="timer">â±ï¸ 300ç§’</div>
                <div class="ui-box" id="target">ğŸ¯ ç›®æ ‡: 60åˆ†</div>
                <div class="ui-box" id="score">â­ 0åˆ†</div>
            </div>

            <!-- çŠ¶æ€å›¾ä¾‹ -->
            <div id="legend">
                <div class="legend-item"><span class="legend-icon">ğŸ®</span>ç©æ¸¸æˆ</div>
                <div class="legend-item"><span class="legend-icon">ğŸš½</span>ä¸Šå•æ‰€</div>
                <div class="legend-item"><span class="legend-icon">ğŸ‘Š</span>æ‰“æ¶</div>
                <div class="legend-item"><span class="legend-icon">ğŸ’¬</span>è¯´è¯</div>
                <div class="legend-item"><span class="legend-icon">ğŸª</span>åƒé›¶é£Ÿ</div>
            </div>
        </div>
    </div>

    <!-- é€‰æ‹©å¼¹çª— -->
    <div id="choiceModal">
        <div class="modal-content">
            <div class="modal-title">
                <span id="modalIcon">ğŸ®</span>
                <span id="modalStatus">ç©æ¸¸æˆ</span>
            </div>
            <div class="modal-subtitle" id="modalSubtitle">è¿™ä½åŒå­¦æ­£åœ¨ç©æ¸¸æˆ</div>
            <div id="modalChoices"></div>
        </div>
    </div>

    <!-- å¼€å§‹/ç»“æŸç•Œé¢ -->
    <div id="overlay">
        <div id="startScreen">
            <h1>ğŸ« æˆ‘æ˜¯ç­é•¿</h1>
            <div class="subtitle">è€å¸ˆå‡ºå»äº†ï¼Œä½ æ¥ç®¡ç­çº§ï¼</div>
            <div class="info">
                ä½ æ˜¯ç­é•¿ï¼Œè´Ÿè´£ç®¡ç†40ååŒå­¦çš„çºªå¾‹<br>
                åŒå­¦ä»¬ä¼šæå„ç§å°åŠ¨ä½œï¼Œç‚¹å‡»å¤´é¡¶çš„æ³¡æ³¡å¤„ç†<br>
                æ³¡æ³¡ä¸å¤„ç†ä¼šè‡ªåŠ¨æ¶ˆå¤±å¹¶æ‰£åˆ†å“¦ï¼<br>
                300ç§’å†…é›†é½ <strong>60åˆ†</strong>ï¼Œè€å¸ˆå›æ¥æ—¶ä½ å°±æ˜¯åˆæ ¼ç­é•¿ï¼
            </div>
            <button class="start-btn" onclick="startGame()">ğŸ“¢ å¼€å§‹ç®¡ç­</button>
        </div>

        <div id="gameOverScreen" class="hidden">
            <div class="result-icon" id="resultIcon">ğŸ†</div>
            <div class="result-title" id="resultTitle"></div>
            <div class="result-score" id="resultScore"></div>
            <button class="start-btn" onclick="startGame()">ğŸ”„ å†æ¥ä¸€æ¬¡</button>
        </div>
    </div>

    <script>
        'use strict';

        // ============ æ¸¸æˆé…ç½® ============
        const CONFIG = {
            totalStudents: 40,
            gameTime: 300,
            targetScore: 60,
            deskRows: 5,
            deskCols: 8,
            maxBubbles: 6,
            bubbleLifetime: 8000,
            baseSpawnInterval: 4000,
            minSpawnInterval: 1500,
            expirePenalty: -1,
        };

        // ============ äº‹ä»¶å®šä¹‰ ============
        const EVENTS = [
            {
                id: 'gaming', icon: 'ğŸ®', name: 'ç©æ¸¸æˆ',
                choices: [
                    { text: 'ä½ ä¸è¦å†ç©äº†', points: 3, type: 'positive', response: 'å¥½å§...æ”¶èµ·æ¥äº†ğŸ˜”' },
                    { text: 'æˆ‘ä¹Ÿè¦ç©', points: 1, type: 'negative', response: 'æ¥æ¥æ¥ä¸€èµ·ï¼ğŸ®' },
                    { text: 'ä¸è§£å†³', points: 0, type: 'neutral', response: 'å˜¿å˜¿ç»§ç»­ç©~ğŸ˜' },
                ]
            },
            {
                id: 'toilet', icon: 'ğŸš½', name: 'ä¸Šå•æ‰€',
                choices: [
                    { text: 'å»å§', points: 3, type: 'positive', response: 'è°¢è°¢ç­é•¿ï¼ğŸƒ' },
                    { text: 'æ†‹ç€', points: 1, type: 'negative', response: 'å‘œå‘œ...å¥½éš¾å—ğŸ˜£' },
                    { text: 'ä½ è¿™ä¹ˆä¸€è¯´æˆ‘ä¹Ÿæƒ³å°¿äº†', points: 0, type: 'neutral', response: 'å“ˆå“ˆå“ˆå“ˆå“ˆğŸ˜‚' },
                ]
            },
            {
                id: 'fighting', icon: 'ğŸ‘Š', name: 'æ‰“æ¶',
                choices: [
                    { text: 'åˆ«æ‰“äº†', points: 3, type: 'positive', response: 'å¥½å§ä¸æ‰“äº†...ğŸ¤' },
                    { text: 'æ‰“ä»–', points: 1, type: 'negative', response: 'ç­é•¿å¸®æˆ‘ï¼ğŸ’ª' },
                    { text: 'æˆ‘ä¹Ÿæ¥äº†', points: -1, type: 'neutral', response: 'ä¸‰ä¸ªäººæ‰“ï¼ğŸ˜ˆ' },
                ]
            },
            {
                id: 'talking', icon: 'ğŸ’¬', name: 'è¯´è¯',
                choices: [
                    { text: 'ä¸è¦å†è¯´äº†', points: 3, type: 'positive', response: 'å¥½çš„å¥½çš„...ğŸ¤' },
                    { text: 'è¯´å•¥å‘¢ï¼Œæˆ‘å¬å¬', points: 1, type: 'negative', response: 'å“ˆå“ˆè·Ÿä½ è¯´å“¦...ğŸ—£ï¸' },
                    { text: 'ä¸ç®¡', points: 0, type: 'neutral', response: 'ç»§ç»­èŠç»§ç»­èŠ~ğŸ’¬' },
                ]
            },
            {
                id: 'snack', icon: 'ğŸª', name: 'åƒé›¶é£Ÿ',
                choices: [
                    { text: 'ä¸è¦åƒäº†', points: 3, type: 'positive', response: 'å¥½å§æ”¶èµ·æ¥äº†ğŸ˜¢' },
                    { text: 'åƒä»€ä¹ˆå‘¢ï¼Œæˆ‘ä¹Ÿè¦åƒ', points: 1, type: 'negative', response: 'ç»™ä½ ä¸€å—ï¼ğŸª' },
                    { text: 'ç›´æ¥æŠŠé›¶é£Ÿæ‰”æ‰', points: 0, type: 'neutral', response: 'å•Šï¼æˆ‘çš„é›¶é£Ÿï¼ğŸ˜­' },
                ]
            }
        ];

        // ============ æ¸¸æˆçŠ¶æ€ ============
        let gameState = {
            running: false,
            timeLeft: CONFIG.gameTime,
            score: 0,
            students: [],          // { id, color }
            activeBubbles: [],     // { studentId, event, timerId, spawnTime }
            timerInterval: null,
            spawnTimeout: null,
        };

        // ============ DOM å¼•ç”¨ ============
        const classroom = document.getElementById('classroom');
        const studentsContainer = document.getElementById('students');
        const timerEl = document.getElementById('timer');
        const scoreEl = document.getElementById('score');
        const choiceModal = document.getElementById('choiceModal');
        const overlay = document.getElementById('overlay');
        const startScreen = document.getElementById('startScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');

        // ============ åˆå§‹åŒ–è¯¾æ¡Œ ============
        function initDesks() {
            const desksContainer = document.getElementById('desks');
            desksContainer.innerHTML = '';
            for (let i = 0; i < CONFIG.deskRows * CONFIG.deskCols; i++) {
                const desk = document.createElement('div');
                desk.className = 'desk';
                desksContainer.appendChild(desk);
            }
        }

        // ============ å­¦ç”Ÿé¢œè‰² ============
        const BODY_COLORS = [
            '#e74c3c', '#3498db', '#2ecc71', '#9b59b6',
            '#f39c12', '#1abc9c', '#e67e22', '#34495e'
        ];

        function getRandomBodyColor() {
            return BODY_COLORS[Math.floor(Math.random() * BODY_COLORS.length)];
        }

        // ============ åˆå§‹åŒ–å­¦ç”Ÿï¼ˆæ— æ³¡æ³¡ï¼‰ ============
        function initStudents() {
            studentsContainer.innerHTML = '';
            gameState.students = [];
            gameState.activeBubbles = [];

            for (let i = 0; i < CONFIG.totalStudents; i++) {
                const student = { id: i, color: getRandomBodyColor() };
                gameState.students.push(student);

                const el = document.createElement('div');
                el.className = 'student';
                el.id = `student-${i}`;

                const body = document.createElement('div');
                body.className = 'student-body';
                body.style.background = student.color;
                body.textContent = i + 1;

                el.appendChild(body);
                studentsContainer.appendChild(el);
            }
        }

        // ============ æ³¡æ³¡ç®¡ç†å™¨ ============
        const BubbleManager = {
            // æ ¹æ®æ¸¸æˆè¿›åº¦è®¡ç®—å½“å‰ç”Ÿæˆé—´éš”
            getCurrentInterval() {
                const elapsed = CONFIG.gameTime - gameState.timeLeft;
                const progress = elapsed / CONFIG.gameTime;
                return CONFIG.baseSpawnInterval - (CONFIG.baseSpawnInterval - CONFIG.minSpawnInterval) * progress;
            },

            // è·å–æ²¡æœ‰æ³¡æ³¡çš„å­¦ç”ŸIDåˆ—è¡¨
            getAvailableStudents() {
                const busyIds = new Set(gameState.activeBubbles.map(b => b.studentId));
                return gameState.students.filter(s => !busyIds.has(s.id)).map(s => s.id);
            },

            // ç”Ÿæˆæ³¡æ³¡
            spawnBubble() {
                if (!gameState.running) return;
                if (gameState.activeBubbles.length >= CONFIG.maxBubbles) {
                    this.scheduleNext();
                    return;
                }

                const available = this.getAvailableStudents();
                if (available.length === 0) {
                    this.scheduleNext();
                    return;
                }

                const studentId = available[Math.floor(Math.random() * available.length)];
                const event = EVENTS[Math.floor(Math.random() * EVENTS.length)];

                this.addBubble(studentId, event);
                this.scheduleNext();
            },

            // æ·»åŠ æ³¡æ³¡åˆ°å­¦ç”Ÿå¤´ä¸Š
            addBubble(studentId, event) {
                const el = document.getElementById(`student-${studentId}`);
                if (!el) return;

                const bubble = document.createElement('div');
                bubble.className = `bubble status-${event.id}`;
                bubble.innerHTML = event.icon;
                bubble.id = `bubble-${studentId}`;
                bubble.onclick = (e) => {
                    e.stopPropagation();
                    showChoices(studentId, event);
                };

                el.insertBefore(bubble, el.firstChild);

                // è¶…æ—¶è‡ªåŠ¨æ¶ˆå¤±
                const timerId = setTimeout(() => {
                    this.expireBubble(studentId);
                }, CONFIG.bubbleLifetime);

                gameState.activeBubbles.push({
                    studentId,
                    event,
                    timerId,
                    spawnTime: Date.now(),
                });
            },

            // æ³¡æ³¡è¶…æ—¶æ¶ˆå¤±
            expireBubble(studentId) {
                const bubble = document.getElementById(`bubble-${studentId}`);
                if (bubble) {
                    bubble.classList.add('expiring');
                    setTimeout(() => bubble.remove(), 400);
                }

                // æ‰£åˆ†
                addScore(CONFIG.expirePenalty, studentId);

                // ä»æ´»è·ƒåˆ—è¡¨ç§»é™¤
                gameState.activeBubbles = gameState.activeBubbles.filter(b => b.studentId !== studentId);
            },

            // ä¸»åŠ¨ç§»é™¤æ³¡æ³¡ï¼ˆç©å®¶ç‚¹å‡»å¤„ç†åï¼‰
            removeBubble(studentId) {
                const entry = gameState.activeBubbles.find(b => b.studentId === studentId);
                if (entry) {
                    clearTimeout(entry.timerId);
                    gameState.activeBubbles = gameState.activeBubbles.filter(b => b.studentId !== studentId);
                }

                const bubble = document.getElementById(`bubble-${studentId}`);
                if (bubble) bubble.remove();
            },

            // è°ƒåº¦ä¸‹ä¸€ä¸ªæ³¡æ³¡
            scheduleNext() {
                if (!gameState.running) return;
                const interval = this.getCurrentInterval();
                const jitter = (Math.random() - 0.5) * interval * 0.4;
                gameState.spawnTimeout = setTimeout(() => this.spawnBubble(), interval + jitter);
            },

            // å¼€å§‹ç”Ÿæˆ
            start() {
                // å…ˆç«‹å³ç”Ÿæˆä¸€ä¸ªï¼Œç¨åå†æŒ‰èŠ‚å¥ç”Ÿæˆ
                setTimeout(() => this.spawnBubble(), 1000);
            },

            // åœæ­¢
            stop() {
                if (gameState.spawnTimeout) {
                    clearTimeout(gameState.spawnTimeout);
                    gameState.spawnTimeout = null;
                }
                // æ¸…é™¤æ‰€æœ‰æ³¡æ³¡çš„è¶…æ—¶è®¡æ—¶å™¨
                gameState.activeBubbles.forEach(b => clearTimeout(b.timerId));
            }
        };

        // ============ æ˜¾ç¤ºé€‰é¡¹å¼¹çª— ============
        let currentChoiceStudentId = null;
        let currentChoiceEvent = null;

        function showChoices(studentId, event) {
            if (!gameState.running) return;

            currentChoiceStudentId = studentId;
            currentChoiceEvent = event;

            document.getElementById('modalIcon').textContent = event.icon;
            document.getElementById('modalStatus').textContent = event.name;
            document.getElementById('modalSubtitle').textContent = `${studentId + 1}å·åŒå­¦æ­£åœ¨${event.name}`;

            const choicesContainer = document.getElementById('modalChoices');
            choicesContainer.innerHTML = '';

            event.choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = `choice-btn choice-${choice.type}`;
                const pointsText = choice.points > 0 ? `+${choice.points}` : `${choice.points}`;
                btn.innerHTML = `${choice.text}<span class="points-tag">(${pointsText}åˆ†)</span>`;
                btn.onclick = () => handleChoice(studentId, event, choice);
                choicesContainer.appendChild(btn);
            });

            choiceModal.classList.add('show');
        }

        // ============ å¤„ç†é€‰æ‹© ============
        function handleChoice(studentId, event, choice) {
            choiceModal.classList.remove('show');

            // ç§»é™¤æ³¡æ³¡
            BubbleManager.removeBubble(studentId);

            // åŠ åˆ†
            addScore(choice.points, studentId);

            // æ˜¾ç¤ºå›åº”
            showResponse(studentId, choice.response);

            currentChoiceStudentId = null;
            currentChoiceEvent = null;
        }

        // ============ ç§¯åˆ†ç³»ç»Ÿ ============
        function addScore(points, studentId) {
            gameState.score += points;

            // æ›´æ–°æ˜¾ç¤º
            scoreEl.textContent = `â­ ${gameState.score}åˆ†`;
            scoreEl.classList.remove('score-animate');
            void scoreEl.offsetWidth;
            scoreEl.classList.add('score-animate');

            // é£˜åˆ†æ•ˆæœ
            showFloatScore(points, studentId);
        }

        function showFloatScore(points, studentId) {
            if (points === 0) return;

            const studentEl = document.getElementById(`student-${studentId}`);
            if (!studentEl) return;

            const rect = studentEl.getBoundingClientRect();
            const classroomRect = classroom.getBoundingClientRect();

            const float = document.createElement('div');
            float.className = 'float-score';
            float.textContent = points > 0 ? `+${points}` : `${points}`;
            float.style.color = points > 0 ? '#2ecc71' : '#e74c3c';
            float.style.left = `${rect.left - classroomRect.left + rect.width / 2}px`;
            float.style.top = `${rect.top - classroomRect.top}px`;
            classroom.appendChild(float);

            setTimeout(() => float.remove(), 1000);
        }

        // ============ æ˜¾ç¤ºå­¦ç”Ÿå›åº” ============
        function showResponse(studentId, text) {
            const studentEl = document.getElementById(`student-${studentId}`);
            if (!studentEl) return;

            // æ¸…é™¤å·²æœ‰å›åº”
            const existing = studentEl.querySelector('.response-bubble');
            if (existing) existing.remove();

            const responseBubble = document.createElement('div');
            responseBubble.className = 'response-bubble';
            responseBubble.textContent = text;
            studentEl.insertBefore(responseBubble, studentEl.firstChild);

            setTimeout(() => responseBubble.remove(), 1500);
        }

        // ============ æ¸¸æˆæ§åˆ¶ ============
        function startGame() {
            // æ¸…ç†æ—§çŠ¶æ€
            if (gameState.timerInterval) clearInterval(gameState.timerInterval);
            BubbleManager.stop();

            gameState.running = true;
            gameState.timeLeft = CONFIG.gameTime;
            gameState.score = 0;
            gameState.activeBubbles = [];

            overlay.classList.add('hidden');
            startScreen.classList.remove('hidden');
            gameOverScreen.classList.add('hidden');

            // åˆå§‹åŒ–
            initDesks();
            initStudents();

            // æ›´æ–°UI
            scoreEl.textContent = 'â­ 0åˆ†';
            timerEl.textContent = `â±ï¸ ${CONFIG.gameTime}ç§’`;

            // å¼€å§‹å€’è®¡æ—¶
            gameState.timerInterval = setInterval(() => {
                if (!gameState.running) return;
                gameState.timeLeft--;
                timerEl.textContent = `â±ï¸ ${gameState.timeLeft}ç§’`;

                // æ—¶é—´ç´§è¿«æé†’
                if (gameState.timeLeft <= 30) {
                    timerEl.style.background = 'rgba(231,76,60,0.15)';
                }
                if (gameState.timeLeft <= 10) {
                    timerEl.style.animation = 'scoreAdd 0.5s ease';
                    setTimeout(() => timerEl.style.animation = '', 500);
                }

                if (gameState.timeLeft <= 0) {
                    endGame(gameState.score >= CONFIG.targetScore);
                }
            }, 1000);

            // å¼€å§‹æ³¡æ³¡ç”Ÿæˆ
            BubbleManager.start();
        }

        function endGame(won) {
            gameState.running = false;
            clearInterval(gameState.timerInterval);
            gameState.timerInterval = null;
            BubbleManager.stop();

            // å…³é—­å¯èƒ½æ‰“å¼€çš„é€‰æ‹©å¼¹çª—
            choiceModal.classList.remove('show');

            overlay.classList.remove('hidden');
            startScreen.classList.add('hidden');
            gameOverScreen.classList.remove('hidden');

            const resultIcon = document.getElementById('resultIcon');
            const resultTitle = document.getElementById('resultTitle');
            const resultScore = document.getElementById('resultScore');

            if (won) {
                resultIcon.textContent = 'ğŸ‰';
                resultTitle.textContent = 'è€å¸ˆå›æ¥äº†ï¼Œä½ æ˜¯ä¸€ä¸ªåˆæ ¼çš„ç­é•¿ï¼';
                resultTitle.className = 'result-title win';
            } else {
                resultIcon.textContent = 'ğŸ˜¢';
                resultTitle.textContent = 'è€å¸ˆå›æ¥äº†ï¼Œç­çº§ä¸€ç‰‡æ··ä¹±ï¼Œä½ è¢«æ’¤èŒäº†ï¼';
                resultTitle.className = 'result-title lose';
            }

            resultScore.textContent = `æœ€ç»ˆå¾—åˆ†: ${gameState.score}åˆ† / ç›®æ ‡: ${CONFIG.targetScore}åˆ†`;

            // é‡ç½®è®¡æ—¶å™¨æ ·å¼
            timerEl.style.background = '';
            timerEl.style.animation = '';
        }

        // ============ å¼¹çª—å¤–éƒ¨ç‚¹å‡»å…³é—­ ============
        choiceModal.addEventListener('click', (e) => {
            if (e.target === choiceModal) {
                choiceModal.classList.remove('show');
                currentChoiceStudentId = null;
                currentChoiceEvent = null;
            }
        });

        // ============ åˆå§‹åŒ– ============
        initDesks();
    </script>
</body>
</html>