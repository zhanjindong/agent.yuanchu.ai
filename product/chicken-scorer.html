<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ¯”é¸¡æ¸¸æˆè®°åˆ†å™¨</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; padding: 16px; color: #fff; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 500px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 16px; font-size: 24px; color: #ffd700; }

        .card { background: rgba(255,255,255,0.05); border-radius: 16px; padding: 20px; margin-bottom: 16px; border: 1px solid rgba(255,255,255,0.1); }
        .card-title { font-size: 15px; color: #ffd700; margin-bottom: 14px; display: flex; align-items: center; gap: 6px; }

        .field { margin-bottom: 12px; }
        .field label { display: block; font-size: 12px; color: #888; margin-bottom: 6px; }
        .field input { width: 100%; padding: 10px 14px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(0,0,0,0.3); color: #fff; font-size: 15px; }
        .field input:focus { outline: none; border-color: #ffd700; }

        .row { display: flex; gap: 10px; }
        .row .field { flex: 1; }

        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 6px; }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: linear-gradient(135deg, #ffd700, #ff8c00); color: #000; font-weight: 600; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2); }
        .btn-danger { background: rgba(220,53,69,0.8); color: #fff; }
        .btn-success { background: rgba(40,167,69,0.8); color: #fff; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .btn-block { width: 100%; }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

        .player-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
        .player-tag { display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; background: rgba(255,215,0,0.1); border: 1px solid rgba(255,215,0,0.3); border-radius: 20px; font-size: 14px; }
        .player-tag .remove { cursor: pointer; color: #ff6b6b; font-size: 18px; line-height: 1; }
        .add-player-row { display: flex; gap: 8px; }
        .add-player-row input { flex: 1; }
        .add-player-row .btn { white-space: nowrap; }

        .tier-inputs { display: flex; gap: 8px; flex-wrap: wrap; }
        .tier-input { width: 70px; }
        .tier-input input { width: 100%; padding: 8px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(0,0,0,0.3); color: #fff; font-size: 14px; text-align: center; }
        .tier-input input:focus { outline: none; border-color: #ffd700; }
        .tier-label { font-size: 10px; color: #888; text-align: center; margin-top: 4px; }

        .lane-tabs { display: flex; gap: 4px; margin-bottom: 14px; }
        .lane-tab { flex: 1; padding: 10px; text-align: center; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; background: rgba(255,255,255,0.05); color: #888; border: 2px solid transparent; }
        .lane-tab.active { background: rgba(255,215,0,0.15); color: #ffd700; border-color: rgba(255,215,0,0.5); }
        .lane-tab.done { background: rgba(40,167,69,0.15); color: #28a745; border-color: rgba(40,167,69,0.3); }
        .lane-tab.done.active { border-color: #28a745; }

        .player-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
        .player-btn { padding: 16px 12px; border-radius: 12px; border: 2px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.05); color: #fff; font-size: 15px; font-weight: 500; cursor: pointer; transition: all 0.2s; text-align: center; position: relative; min-height: 56px; display: flex; align-items: center; justify-content: center; }
        .player-btn:active { transform: scale(0.96); }
        .player-btn.selected { border-color: #ffd700; background: rgba(255,215,0,0.15); color: #ffd700; cursor: default; }
        .player-btn .rank-badge { position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; border-radius: 50%; font-size: 12px; font-weight: 700; display: flex; align-items: center; justify-content: center; }
        .rank-1 { background: linear-gradient(135deg, #ffd700, #ff8c00); color: #000; }
        .rank-2 { background: linear-gradient(135deg, #c0c0c0, #a0a0a0); color: #000; }
        .rank-3 { background: linear-gradient(135deg, #cd7f32, #8b4513); color: #fff; }
        .rank-other { background: rgba(255,255,255,0.2); color: #fff; }

        .lane-ranking { font-size: 13px; color: #aaa; margin-bottom: 10px; min-height: 20px; }
        .lane-ranking span { color: #ffd700; }

        .lane-actions { display: flex; gap: 8px; }

        .lucky-section { margin-top: 4px; }
        .lucky-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .lucky-row:last-child { border-bottom: none; }
        .lucky-name { font-size: 14px; flex: 1; }
        .lucky-controls { display: flex; align-items: center; gap: 8px; }
        .lucky-count { font-size: 16px; font-weight: 600; color: #ffd700; min-width: 24px; text-align: center; }
        .lucky-btn { width: 32px; height: 32px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: #fff; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .lucky-btn:active { transform: scale(0.9); }
        .lucky-btn.plus { border-color: rgba(255,215,0,0.5); color: #ffd700; }

        .round-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
        .round-label { font-size: 18px; color: #ffd700; font-weight: 600; }

        .result-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .result-card { background: rgba(0,0,0,0.2); border-radius: 12px; padding: 14px; text-align: center; border: 2px solid transparent; }
        .result-card.win { border-color: rgba(40,167,69,0.5); }
        .result-card.lose { border-color: rgba(220,53,69,0.3); }
        .result-name { font-size: 13px; color: #aaa; margin-bottom: 6px; }
        .result-money { font-size: 22px; font-weight: 700; }
        .result-money.positive { color: #28a745; }
        .result-money.negative { color: #dc3545; }
        .result-money.zero { color: #888; }
        .result-detail { font-size: 11px; color: #666; margin-top: 6px; }
        .lucky-badge { display: inline-block; padding: 2px 8px; background: linear-gradient(135deg, #ffd700, #ff8c00); border-radius: 4px; color: #000; font-size: 10px; font-weight: 600; margin-top: 6px; }

        .history-toggle { cursor: pointer; display: flex; align-items: center; justify-content: space-between; }
        .history-toggle .arrow { transition: transform 0.2s; }
        .history-toggle .arrow.open { transform: rotate(180deg); }
        .history-item { background: rgba(0,0,0,0.15); border-radius: 10px; padding: 12px; margin-top: 10px; }
        .history-item-title { font-size: 13px; color: #888; margin-bottom: 8px; }
        .history-row { display: flex; justify-content: space-between; font-size: 13px; padding: 3px 0; }
        .history-row .name { color: #aaa; }
        .history-row .amount.pos { color: #28a745; }
        .history-row .amount.neg { color: #dc3545; }

        .final-section { background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,140,0,0.05)); border: 2px solid rgba(255,215,0,0.3); }
        .final-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .final-card { background: rgba(0,0,0,0.3); border-radius: 12px; padding: 16px; text-align: center; }
        .final-card .name { font-size: 14px; color: #aaa; margin-bottom: 8px; }
        .final-card .total { font-size: 28px; font-weight: 700; }
        .final-card .total.win { color: #28a745; }
        .final-card .total.lose { color: #dc3545; }
        .final-card .total.zero { color: #888; }
        .zero-sum { text-align: center; font-size: 12px; color: #666; margin-top: 12px; }
        .zero-sum.ok { color: #28a745; }
        .zero-sum.err { color: #dc3545; }

        .confirm-bar { display: flex; gap: 8px; margin-top: 14px; }
        .confirm-bar .btn { flex: 1; }

        .hidden { display: none !important; }

        @media (max-width: 360px) {
            .player-grid { grid-template-columns: 1fr; }
            .result-grid { grid-template-columns: 1fr; }
            .final-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” æ¯”é¸¡è®°åˆ†å™¨</h1>
        <div id="app"></div>
    </div>

    <script>
    // ====== State ======
    const DEFAULT_STATE = {
        phase: 'setup',
        config: {
            players: ['ç©å®¶1', 'ç©å®¶2', 'ç©å®¶3', 'ç©å®¶4'],
            tiers: [5, 10, 15],
            luckyMoney: 50
        },
        currentRound: 1,
        currentRoundData: {
            lanes: [[], [], []],
            currentLane: 0,
            luckyMap: {}
        },
        rounds: [],
        totals: {}
    };

    let S = JSON.parse(JSON.stringify(DEFAULT_STATE));
    let historyOpen = false;

    // ====== Persistence ======
    const STORAGE_KEY = 'chicken_scorer_state';

    function saveState() {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(S));
        } catch (e) {}
    }

    function loadState() {
        try {
            const data = localStorage.getItem(STORAGE_KEY);
            if (data) return JSON.parse(data);
        } catch (e) {}
        return null;
    }

    function clearState() {
        try { localStorage.removeItem(STORAGE_KEY); } catch (e) {}
    }

    // ====== Score Engine ======
    function calculateLaneScore(laneRanking, tiers, numPlayers) {
        const scores = {};
        for (let i = 0; i < numPlayers; i++) scores[i] = 0;
        if (laneRanking.length !== numPlayers) return scores;

        const winnerIdx = laneRanking[0];
        let winnerTotal = 0;

        for (let rank = 1; rank < laneRanking.length; rank++) {
            const playerIdx = laneRanking[rank];
            const payment = tiers[rank - 1] || 0;
            scores[playerIdx] = -payment;
            winnerTotal += payment;
        }
        scores[winnerIdx] = winnerTotal;
        return scores;
    }

    function calculateLuckyScore(luckyMap, numPlayers, luckyMoney) {
        const scores = {};
        for (let i = 0; i < numPlayers; i++) scores[i] = 0;

        for (const [pidxStr, count] of Object.entries(luckyMap)) {
            const pidx = parseInt(pidxStr);
            if (count <= 0) continue;
            const earning = count * luckyMoney * (numPlayers - 1);
            scores[pidx] += earning;
            const perPersonPay = count * luckyMoney;
            for (let i = 0; i < numPlayers; i++) {
                if (i !== pidx) scores[i] -= perPersonPay;
            }
        }
        return scores;
    }

    function calculateRoundScore() {
        const n = S.config.players.length;
        const tiers = S.config.tiers;
        const totals = {};
        for (let i = 0; i < n; i++) totals[i] = 0;

        const laneScores = [];
        for (let l = 0; l < 3; l++) {
            const ls = calculateLaneScore(S.currentRoundData.lanes[l], tiers, n);
            laneScores.push(ls);
            for (let i = 0; i < n; i++) totals[i] += ls[i];
        }

        const luckyScores = calculateLuckyScore(S.currentRoundData.luckyMap, n, S.config.luckyMoney);
        for (let i = 0; i < n; i++) totals[i] += luckyScores[i];

        return { laneScores, luckyScores, totals };
    }

    function validateZeroSum(scores) {
        const sum = Object.values(scores).reduce((a, b) => a + b, 0);
        return sum === 0;
    }

    // ====== Actions ======
    function addPlayer() {
        const input = document.getElementById('inp-new-player');
        const name = (input.value || '').trim();
        if (!name) return;
        if (S.config.players.includes(name)) { alert('ç©å®¶å§“åä¸èƒ½é‡å¤ï¼'); return; }
        if (S.config.players.length >= 8) { alert('æœ€å¤šæ”¯æŒ8åç©å®¶ï¼'); return; }
        S.config.players.push(name);
        S.config.tiers.push((S.config.tiers[S.config.tiers.length - 1] || 5) + 5);
        input.value = '';
        saveState();
        render();
        input.focus();
    }

    function removePlayer(idx) {
        if (S.config.players.length <= 2) { alert('è‡³å°‘éœ€è¦2åç©å®¶ï¼'); return; }
        S.config.players.splice(idx, 1);
        S.config.tiers = S.config.tiers.slice(0, S.config.players.length - 1);
        saveState();
        render();
    }

    function updateTier(idx, val) {
        S.config.tiers[idx] = Math.max(0, parseInt(val) || 0);
        saveState();
    }

    function updateLuckyMoney(val) {
        S.config.luckyMoney = Math.max(0, parseInt(val) || 0);
        saveState();
    }

    function startGame() {
        if (S.config.players.length < 2) { alert('è‡³å°‘éœ€è¦2åç©å®¶ï¼'); return; }
        if (S.config.players.some(p => !p.trim())) { alert('ç©å®¶å§“åä¸èƒ½ä¸ºç©ºï¼'); return; }
        const tierCount = S.config.players.length - 1;
        S.config.tiers = S.config.tiers.slice(0, tierCount);
        while (S.config.tiers.length < tierCount) S.config.tiers.push((S.config.tiers[S.config.tiers.length - 1] || 5) + 5);
        S.phase = 'playing';
        S.currentRound = 1;
        S.rounds = [];
        S.totals = {};
        S.config.players.forEach((_, i) => S.totals[i] = 0);
        resetRoundData();
        saveState();
        render();
    }

    function resetRoundData() {
        S.currentRoundData = { lanes: [[], [], []], currentLane: 0, luckyMap: {} };
    }

    function switchLane(idx) {
        S.currentRoundData.currentLane = idx;
        saveState();
        render();
    }

    function selectPlayer(playerIdx) {
        const lane = S.currentRoundData.currentLane;
        const ranking = S.currentRoundData.lanes[lane];
        if (ranking.includes(playerIdx)) return;
        ranking.push(playerIdx);

        if (ranking.length === S.config.players.length) {
            if (lane < 2) {
                S.currentRoundData.currentLane = lane + 1;
            }
        }
        saveState();
        render();
    }

    function undoLastSelection() {
        const lane = S.currentRoundData.currentLane;
        const ranking = S.currentRoundData.lanes[lane];
        if (ranking.length > 0) {
            ranking.pop();
            saveState();
            render();
        }
    }

    function isCurrentRoundEmpty() {
        return S.currentRoundData.lanes.every(l => l.length === 0) &&
               Object.keys(S.currentRoundData.luckyMap).length === 0;
    }

    function undoLastRound() {
        if (S.rounds.length === 0) return;
        const lastRound = S.rounds.pop();
        for (let i = 0; i < S.config.players.length; i++) {
            S.totals[i] = (S.totals[i] || 0) - lastRound.results[i];
        }
        S.currentRoundData = {
            lanes: lastRound.lanes.map(l => [...l]),
            currentLane: 0,
            luckyMap: { ...lastRound.luckyMap }
        };
        S.phase = 'playing';
        saveState();
        render();
    }

    function recalcCurrentRound() {
        if (!confirm('ç¡®å®šè¦é‡æ–°è®¡ç®—æœ¬è½®å—ï¼Ÿ')) return;
        undoLastRound();
    }

    function recalcPreviousRound() {
        if (!confirm('ç¡®å®šè¦æ’¤å›ä¸Šä¸€è½®é‡æ–°è®¡ç®—å—ï¼Ÿ')) return;
        S.currentRound--;
        undoLastRound();
    }

    function resetCurrentLane() {
        const lane = S.currentRoundData.currentLane;
        S.currentRoundData.lanes[lane] = [];
        saveState();
        render();
    }

    function addLucky(pidx) {
        if (!S.currentRoundData.luckyMap[pidx]) S.currentRoundData.luckyMap[pidx] = 0;
        S.currentRoundData.luckyMap[pidx]++;
        saveState();
        render();
    }

    function removeLucky(pidx) {
        if (S.currentRoundData.luckyMap[pidx] > 0) {
            S.currentRoundData.luckyMap[pidx]--;
            if (S.currentRoundData.luckyMap[pidx] === 0) delete S.currentRoundData.luckyMap[pidx];
        }
        saveState();
        render();
    }

    function allLanesDone() {
        return S.currentRoundData.lanes.every(l => l.length === S.config.players.length);
    }

    function settleRound() {
        if (!allLanesDone()) { alert('è¯·å®Œæˆä¸‰é“æ’ååå†ç»“ç®—ï¼'); return; }

        const result = calculateRoundScore();
        const roundRecord = {
            lanes: S.currentRoundData.lanes.map(l => [...l]),
            luckyMap: { ...S.currentRoundData.luckyMap },
            results: { ...result.totals },
            laneScores: result.laneScores,
            luckyScores: result.luckyScores
        };
        S.rounds.push(roundRecord);

        for (let i = 0; i < S.config.players.length; i++) {
            S.totals[i] = (S.totals[i] || 0) + result.totals[i];
        }

        S.phase = 'roundResult';
        saveState();
        render();
    }

    function nextRound() {
        S.currentRound++;
        resetRoundData();
        S.phase = 'playing';
        saveState();
        render();
    }

    function endGame() {
        if (S.phase === 'playing' && !allLanesDone()) {
            if (!confirm('å½“å‰è½®æ¬¡æœªå®Œæˆï¼Œç¡®å®šç»“æŸæ¸¸æˆå—ï¼Ÿæœªå®Œæˆçš„è½®æ¬¡å°†ä¸è®¡åˆ†ã€‚')) return;
        }
        if (S.phase === 'playing' && allLanesDone()) {
            if (confirm('å½“å‰è½®æ¬¡å·²å®Œæˆæ’åä½†æœªç»“ç®—ï¼Œæ˜¯å¦å…ˆç»“ç®—æœ¬è½®ï¼Ÿ')) {
                settleRound();
                S.phase = 'finished';
                saveState();
                render();
                return;
            }
        }
        S.phase = 'finished';
        saveState();
        render();
    }

    function newGame() {
        if (!confirm('ç¡®å®šå¼€å§‹æ–°æ¸¸æˆï¼Ÿæ‰€æœ‰æ•°æ®å°†æ¸…é™¤ï¼')) return;
        const players = [...S.config.players];
        const tiers = [...S.config.tiers];
        const lucky = S.config.luckyMoney;
        S = JSON.parse(JSON.stringify(DEFAULT_STATE));
        S.config.players = players;
        S.config.tiers = tiers;
        S.config.luckyMoney = lucky;
        clearState();
        render();
    }

    function restoreGame() {
        render();
    }

    function discardRestore() {
        clearState();
        S = JSON.parse(JSON.stringify(DEFAULT_STATE));
        render();
    }

    function updatePlayerName(idx, val) {
        S.config.players[idx] = val;
        saveState();
    }

    // ====== Render ======
    function render() {
        const app = document.getElementById('app');
        if (S.phase === 'setup') {
            app.innerHTML = renderSetup();
        } else if (S.phase === 'playing') {
            app.innerHTML = renderPlaying();
        } else if (S.phase === 'roundResult') {
            app.innerHTML = renderRoundResult();
        } else if (S.phase === 'finished') {
            app.innerHTML = renderFinished();
        }
    }

    function renderSetup() {
        const players = S.config.players;
        const tiers = S.config.tiers;
        const tierCount = Math.max(players.length - 1, 1);

        while (tiers.length < tierCount) tiers.push((tiers[tiers.length - 1] || 5) + 5);
        if (tiers.length > tierCount) tiers.length = tierCount;

        return `
        <div class="card">
            <div class="card-title">ğŸ‘¥ ç©å®¶ç®¡ç† <span style="color:#888;font-size:12px;margin-left:auto;">${players.length}äºº / ${tierCount}æ¡£</span></div>
            <div class="player-tags">
                ${players.map((p, i) => `
                    <div class="player-tag">
                        <span>${esc(p)}</span>
                        <span class="remove" onclick="removePlayer(${i})">Ã—</span>
                    </div>
                `).join('')}
            </div>
            <div class="add-player-row">
                <input type="text" id="inp-new-player" placeholder="è¾“å…¥å§“åï¼Œå›è½¦æ·»åŠ " onkeypress="if(event.key==='Enter')addPlayer()">
                <button class="btn btn-primary btn-sm" onclick="addPlayer()">æ·»åŠ </button>
            </div>
        </div>

        <div class="card">
            <div class="card-title">ğŸ’° é‡‘é¢è®¾ç½®</div>
            <div class="field">
                <label>æ¡£ä½é‡‘é¢ï¼ˆç¬¬2åä»˜ç¬¬1æ¡£ï¼Œç¬¬3åä»˜ç¬¬2æ¡£...ç»™èµ¢å®¶ï¼‰</label>
                <div class="tier-inputs">
                    ${tiers.map((t, i) => `
                        <div class="tier-input">
                            <input type="number" value="${t}" min="0" onchange="updateTier(${i}, this.value)">
                            <div class="tier-label">ç¬¬${i + 1}æ¡£</div>
                        </div>
                    `).join('')}
                </div>
            </div>
            <div class="field" style="margin-bottom:0">
                <label>å–œé’±é‡‘é¢ï¼ˆæœ‰å–œè€…ä»æ¯äººæ”¶å–çš„é‡‘é¢ï¼‰</label>
                <input type="number" value="${S.config.luckyMoney}" min="0" onchange="updateLuckyMoney(this.value)" style="max-width:120px">
            </div>
        </div>

        <button class="btn btn-primary btn-block" onclick="startGame()" ${players.length < 2 ? 'disabled' : ''} style="padding:14px;font-size:16px;">
            ğŸ® å¼€å§‹æ¸¸æˆ
        </button>`;
    }

    function renderPlaying() {
        const players = S.config.players;
        const rd = S.currentRoundData;
        const lane = rd.currentLane;
        const ranking = rd.lanes[lane];

        const laneTabs = [0, 1, 2].map(i => {
            const done = rd.lanes[i].length === players.length;
            const active = i === lane;
            let cls = 'lane-tab';
            if (done) cls += ' done';
            if (active) cls += ' active';
            return `<div class="${cls}" onclick="switchLane(${i})">ç¬¬${i + 1}é“${done ? ' âœ“' : ''}</div>`;
        }).join('');

        const selectedSet = new Set(ranking);
        const playerBtns = players.map((p, i) => {
            const rankPos = ranking.indexOf(i);
            const isSelected = rankPos !== -1;
            let cls = 'player-btn';
            if (isSelected) cls += ' selected';
            let badge = '';
            if (isSelected) {
                const r = rankPos + 1;
                let rcls = r === 1 ? 'rank-1' : r === 2 ? 'rank-2' : r === 3 ? 'rank-3' : 'rank-other';
                badge = `<span class="rank-badge ${rcls}">${r}</span>`;
            }
            return `<div class="${cls}" onclick="${isSelected ? '' : `selectPlayer(${i})`}">${esc(p)}${badge}</div>`;
        }).join('');

        const rankDisplay = ranking.length > 0
            ? 'æ’åï¼š' + ranking.map((pi, ri) => `<span>${ri + 1}.${esc(players[pi])}</span>`).join(' ')
            : 'ç‚¹å‡»ç©å®¶ï¼Œå…ˆç‚¹çš„ç‰Œæœ€å¤§';

        const luckyRows = players.map((p, i) => {
            const cnt = rd.luckyMap[i] || 0;
            return `
            <div class="lucky-row">
                <span class="lucky-name">${esc(p)}</span>
                <div class="lucky-controls">
                    <div class="lucky-btn" onclick="removeLucky(${i})" ${cnt === 0 ? 'style="opacity:0.3"' : ''}>âˆ’</div>
                    <span class="lucky-count">${cnt}</span>
                    <div class="lucky-btn plus" onclick="addLucky(${i})">+</div>
                </div>
            </div>`;
        }).join('');

        const canSettle = allLanesDone();
        const runningTotalHtml = renderRunningTotal();
        const historyHtml = renderHistory();

        return `
        <div class="card">
            <div class="round-header">
                <div class="round-label">ç¬¬ ${S.currentRound} è½®</div>
                <button class="btn btn-danger btn-sm" onclick="endGame()">ç»“æŸæ¸¸æˆ</button>
            </div>

            <div class="lane-tabs">${laneTabs}</div>

            <div class="player-grid">${playerBtns}</div>

            <div class="lane-ranking">${rankDisplay}</div>

            <div class="lane-actions">
                <button class="btn btn-secondary btn-sm" onclick="undoLastSelection()" ${ranking.length === 0 ? 'disabled' : ''}>â†© æ’¤é”€</button>
                <button class="btn btn-secondary btn-sm" onclick="resetCurrentLane()" ${ranking.length === 0 ? 'disabled' : ''}>ğŸ”„ é‡ç½®æœ¬é“</button>
            </div>
        </div>

        <div class="card">
            <div class="card-title">ğŸ å–œé’±è®¾ç½® <span style="color:#888;font-size:12px;margin-left:auto;">æ¯å–œ ${S.config.luckyMoney}å…ƒ/äºº</span></div>
            <div class="lucky-section">${luckyRows}</div>
        </div>

        <button class="btn btn-primary btn-block" onclick="settleRound()" ${!canSettle ? 'disabled' : ''} style="padding:14px;font-size:16px;">
            ğŸ“Š ç»“ç®—æœ¬è½®
        </button>

        ${S.rounds.length > 0 && isCurrentRoundEmpty() ? `
        <button class="btn btn-secondary btn-block" onclick="recalcPreviousRound()" style="margin-top:8px;padding:12px;font-size:14px;">
            ğŸ”„ é‡ç®—ä¸Šä¸€è½®
        </button>
        ` : ''}

        ${runningTotalHtml}
        ${historyHtml}`;
    }

    function renderRoundResult() {
        const lastRound = S.rounds[S.rounds.length - 1];
        const players = S.config.players;
        const tiers = S.config.tiers;

        let detailRows = '';
        for (let i = 0; i < players.length; i++) {
            const laneDetails = [0, 1, 2].map(l => {
                const v = lastRound.laneScores[l][i];
                return `${l + 1}é“:${fmtMoney(v)}`;
            }).join(' ');

            const luckyV = lastRound.luckyScores[i] || 0;
            const luckyStr = luckyV !== 0 ? ` å–œ:${fmtMoney(luckyV)}` : '';
            detailRows += `<div style="font-size:11px;color:#888;">${laneDetails}${luckyStr}</div>`;
        }

        const resultCards = players.map((p, i) => {
            const v = lastRound.results[i];
            const cls = v > 0 ? 'positive' : v < 0 ? 'negative' : 'zero';
            const cardCls = v > 0 ? 'win' : v < 0 ? 'lose' : '';
            const luckyCount = lastRound.luckyMap[i] || 0;

            const ld = [0, 1, 2].map(l => `${l + 1}é“:${fmtMoney(lastRound.laneScores[l][i])}`).join(' ');
            const luckyV = lastRound.luckyScores[i] || 0;
            const ls = luckyV !== 0 ? `<br>å–œé’±:${fmtMoney(luckyV)}` : '';

            return `
            <div class="result-card ${cardCls}">
                <div class="result-name">${esc(p)}</div>
                <div class="result-money ${cls}">${fmtMoney(v)}</div>
                <div class="result-detail">${ld}${ls}</div>
                ${luckyCount > 0 ? `<div class="lucky-badge">ğŸ‰ ${luckyCount}å–œ</div>` : ''}
            </div>`;
        }).join('');

        const zs = validateZeroSum(lastRound.results);
        const zsHtml = `<div class="zero-sum ${zs ? 'ok' : 'err'}">${zs ? 'âœ“ é›¶å’Œæ ¡éªŒé€šè¿‡' : 'âš  é›¶å’Œæ ¡éªŒå¤±è´¥'}</div>`;

        const runningTotalHtml = renderRunningTotal();
        const historyHtml = renderHistory();

        return `
        <div class="card">
            <div class="card-title">ğŸ“Š ç¬¬ ${S.rounds.length} è½®ç»“ç®—</div>
            <div class="result-grid">${resultCards}</div>
            ${zsHtml}
        </div>

        <div class="confirm-bar">
            <button class="btn btn-primary" onclick="nextRound()" style="flex:2">â–¶ ä¸‹ä¸€è½®</button>
            <button class="btn btn-secondary" onclick="recalcCurrentRound()">ğŸ”„ é‡ç®—</button>
            <button class="btn btn-danger" onclick="endGame()">ç»“æŸæ¸¸æˆ</button>
        </div>

        ${runningTotalHtml}
        ${historyHtml}`;
    }

    function renderRunningTotal() {
        if (S.rounds.length === 0) return '';
        const players = S.config.players;
        const sorted = players.map((p, i) => ({ name: p, total: S.totals[i] || 0 }))
            .sort((a, b) => b.total - a.total);

        const cards = sorted.map(s => {
            const cls = s.total > 0 ? 'win' : s.total < 0 ? 'lose' : 'zero';
            return `
            <div class="final-card">
                <div class="name">${esc(s.name)}</div>
                <div class="total ${cls}">${fmtMoney(s.total)}</div>
            </div>`;
        }).join('');

        return `
        <div class="card" style="margin-top:16px;">
            <div class="card-title">ğŸ† ç´¯è®¡æ€»åˆ†</div>
            <div class="final-grid">${cards}</div>
        </div>`;
    }

    function renderHistory() {
        if (S.rounds.length === 0) return '';
        const players = S.config.players;

        const items = S.rounds.map((r, ri) => {
            const rows = players.map((p, i) => {
                const v = r.results[i];
                const cls = v > 0 ? 'pos' : v < 0 ? 'neg' : '';
                return `<div class="history-row"><span class="name">${esc(p)}</span><span class="amount ${cls}">${fmtMoney(v)}</span></div>`;
            }).join('');
            return `<div class="history-item"><div class="history-item-title">ç¬¬ ${ri + 1} è½®</div>${rows}</div>`;
        }).join('');

        return `
        <div class="card" style="margin-top:16px;">
            <div class="card-title history-toggle" onclick="toggleHistory()">
                ğŸ“œ å†å²è®°å½• (${S.rounds.length}è½®)
                <span class="arrow ${historyOpen ? 'open' : ''}">â–¼</span>
            </div>
            <div class="${historyOpen ? '' : 'hidden'}" id="history-content">${items}</div>
        </div>`;
    }

    function toggleHistory() {
        historyOpen = !historyOpen;
        render();
    }

    function renderFinished() {
        const players = S.config.players;
        const sorted = players.map((p, i) => ({ name: p, total: S.totals[i] || 0 }))
            .sort((a, b) => b.total - a.total);

        const cards = sorted.map((s, i) => {
            const cls = s.total > 0 ? 'win' : s.total < 0 ? 'lose' : 'zero';
            const medal = i === 0 && s.total > 0 ? 'ğŸ¥‡ ' : '';
            return `
            <div class="final-card">
                <div class="name">${medal}${esc(s.name)}</div>
                <div class="total ${cls}">${fmtMoney(s.total)}</div>
            </div>`;
        }).join('');

        const sum = Object.values(S.totals).reduce((a, b) => a + b, 0);
        const zsOk = sum === 0;
        const zsHtml = `<div class="zero-sum ${zsOk ? 'ok' : 'err'}">${zsOk ? 'âœ“ é›¶å’Œæ ¡éªŒé€šè¿‡' : 'âš  é›¶å’Œæ ¡éªŒå¼‚å¸¸ (å·®é¢:' + sum + ')'}</div>`;

        const historyHtml = renderHistory();

        return `
        <div class="card final-section">
            <div class="card-title" style="justify-content:center;font-size:18px;">ğŸ† æœ€ç»ˆç»“ç®— Â· å…± ${S.rounds.length} è½®</div>
            <div class="final-grid">${cards}</div>
            ${zsHtml}
        </div>

        ${historyHtml}

        <button class="btn btn-primary btn-block" onclick="newGame()" style="margin-top:16px;padding:14px;font-size:16px;">
            ğŸ”„ æ–°æ¸¸æˆ
        </button>`;
    }

    // ====== Helpers ======
    function esc(s) {
        const d = document.createElement('div');
        d.textContent = s;
        return d.innerHTML;
    }

    function fmtMoney(v) {
        if (v > 0) return '+' + v;
        if (v < 0) return '' + v;
        return '0';
    }

    // ====== Init ======
    (function init() {
        const saved = loadState();
        if (saved && saved.phase && saved.phase !== 'setup') {
            S = saved;
            if (!S.currentRoundData) resetRoundData();
            if (!S.totals) S.totals = {};
            render();
            return;
        }
        if (saved && saved.config) {
            S.config = saved.config;
        }
        render();
    })();
    </script>
</body>
</html>
